<!-- https://www.flaticon.com/search/2?word=country -->

<html lang="en">

<head>
     <title>House of Links</title>

    <style type="text/css">
        html, body {
                        font: 11pt times;
                }
	#topFrame {
			width:1250px
			}
        #statement {
                        width:85%;
                        float:right;
                        height: 19px;
                        border: 1px solid darkgray
                }
        #network {width: 100%;
                        height:94%;
                }
        #statement2 {
                        width:1250px;
                        height: 3%;
                        border: 1px solid darkgray
                }
    </style>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.js"></script>
    <script src="names.js" charset="UTF-8"></script>
    <link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.css" rel="stylesheet"/>

    <script type="text/javascript">

   //init()
   //
   //Starts the network by requesting the initial movies via a pengine call.
        const graphql = "http://localhost:4000/graphql"

        var nodes, edges, network;

        var instructionText = 'Use the searchbox to the left to <b>find people by names</b>. Double-click on nodes to <b>find related entities</b>. Select a node and right-click to <b>go to Wikipedia</b>.'

        function visualise(parent, relation, entity) {
                
                if (nodes.get(entity._id)==null) {

                        var node = {
                                id: entity._id,
                                uri: entity._id,
                                next: 0,
                                mass: 2.5,
                        }

                        if (parent!=null){
                                node.x = network.getPositions(parent)[parent].x;
                                node.y =  network.getPositions(parent)[parent].y;
                        }
                        
                        
                        if (entity._type[0] == "Country") {
                                node.shape = 'image'
                                node.image = "https://image.flaticon.com/icons/svg/664/664577.svg"
                                node.size = 60
                                node.label = entity.label
                                node.type = "country"
                        } else if (entity._type[0] == "Person") {
                                node.size = 30
                                node.type = "person"
                                if (entity.thumbnail!=null) {
                                        node.image = entity.thumbnail
                                        node.shape = 'circularImage'
                                        node.size = 40
                                } else if (entity.gender=="female") {
                                        node.image = "https://image.flaticon.com/icons/svg/201/201634.svg"
                                        node.shape = 'circularImage'
                                } else if (entity.gender=="male") {
                                        node.image = "https://image.flaticon.com/icons/svg/145/145843.svg"
                                        node.shape = 'circularImage'
                                } else {
                                        node.image = "https://image.flaticon.com/icons/svg/149/149071.svg"
                                        node.shape = 'circularImage'
                                }
                                

                                var year = ""
                                if (entity.birthYear!=null || entity.deathYear!=null) {
                                        year = "\n"
                                        if (entity.birthYear!=null) {
                                                year = year + String(entity.birthYear)
                                        }
                                        year = year + " - "
                                        if (entity.deathYear!=null) {
                                                year = year + String(entity.deathYear)
                                        }
                                }

                                var description = ""
                                if (entity.description!=null) {
                                        description = entity.description + "<br><br>"
                                }

                                node.label = decodeURI(entity.label) + year
                                node.title = description + '<b>See:</b> ' + entity._id.replace("http://dbpedia.org/resource/", "https://en.wikipedia.org/wiki/")
                                
                        }

                        try {
                                nodes.add(node);
                        }
                        catch (err) { console.log("Error when visualising node: " + JSON.stringify(node)) };
                }

                if (parent!=null && relation!=null) {
                        var edge = {}
                        if (relation=="child") {
                                edge = {
                                        id: parent + "_child_" + entity._id,
                                        from: parent,
                                        to: entity._id,
                                        label: "child",
                                        arrows: {
                                                to: true
                                        }
                                }
                        }
                        if (relation=="parent") {
                                edge = {
                                        id: entity._id + "_child_" + parent,
                                        from: entity._id,
                                        to: parent,
                                        label: "child",
                                        arrows: {
                                                to: true
                                        }
                                }
                        }
                        if (relation=="successor") {
                                edge = {
                                        id: parent + "_successor_" + entity._id,
                                        from: parent,
                                        to: entity._id,
                                        label: "successor",
                                        arrows: {
                                                to: true
                                        }
                                }
                        }
                        if (relation=="predecessor") {
                                edge = {
                                        id: entity._id + "_successor_" + parent,
                                        from: entity._id,
                                        to: parent,
                                        label: "successor",
                                        arrows: {
                                                to: true
                                        }
                                }
                        }
                        if (relation=="spouse") {
                                var vertices = [entity._id, parent];
                                vertices.sort();
                                edge = {
                                        id: vertices[0] + "_spouse_" + vertices[1],
                                        from: vertices[0],
                                        to: vertices[1],
                                        label: "spouse",
                                        arrows: {
                                                from: true,
                                                to: true
                                        }
                                }
                        }
                        if (relation=="birthCountry" || relation=="deathCountry") {
                                var edgeId = parent + "_country_" + entity._id;
                                if (edges.get(edgeId)!=null) {
                                        edges.update([{id:edgeId, label:"birthCountry \n deathCountry"}]);
                                } else {
                                        edge = {
                                                id: edgeId,
                                                from: parent,
                                                to: entity._id,
                                                label: relation,
                                                arrows: {
                                                        to: true
                                                }
                                        }
                                }
                        }
                        try {
                                edges.add(edge);
                        }
                        catch (err) { console.log("Error when visualising edge: " + JSON.stringify(entity)) };
                }
                        
                for (var property in entity) {

                        if ( entity[property] != null && typeof entity[property] === 'object' && entity[property].constructor === Object) {
                                visualise(entity._id, property, entity[property])
                        }

                        if (entity[property] != null && typeof entity[property] === 'object' && entity[property].constructor === Array) {
                                
                                entity[property].forEach(value => {


                                        if (value != null && typeof value === 'object' && value.constructor === Object) {
                                                visualise(entity._id, property, value)
                                        } 
                                })
                        }
                }
                
        }
        
        function init(name){           
                draw(); 

                console.log("Searching for: " + name)
                
                fetch(graphql, {
                        method: 'POST',
                        headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        },
                        body: JSON.stringify({query: `{ Person(filter:{label: "`+ name +`"}){ _id _type label description gender thumbnail birthYear deathYear birthCountry { _id _type label } deathCountry { _id _type label } } }`})
                        })
                        .then(r => r.json())
                        .then(data => {
                                visualise(null, null, data.data.Person[0]);
                                instruction();
                        });
        };


        function getRelated(parent){
                var parentNode = nodes.get(parent);

                if (parentNode.type=="person") {
                        // successor { _id _type label description gender thumbnail birthYear deathYear birthCountry { _id _type label } deathCountry { _id _type label } } predecessor { _id _type label description gender thumbnail birthYear deathYear birthCountry { _id _type label } deathCountry { _id _type label } }
                        document.getElementById('statement').innerHTML = "Retrieving and visualising the knowledge graph. Please wait...";
                        var query = `{ Person(filter: { _id:"`+ parent +`"}) { _id child { _id _type label description gender thumbnail birthYear deathYear birthCountry { _id _type label } deathCountry { _id _type label } } parent { _id _type label description gender thumbnail birthYear deathYear birthCountry { _id _type label } deathCountry { _id _type label } } spouse { _id _type label description gender thumbnail birthYear deathYear birthCountry { _id _type label } deathCountry { _id _type label } } } }`

                        fetch(graphql, {
                                method: 'POST',
                                headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                },
                                body: JSON.stringify({query: query})
                                })
                                .then(r => r.json())
                                .then(data => {
                                        visualise(null, null, data.data.Person[0]);
                                        instruction();
                                });
                }

        };



   //draw()
   //
   //Initiates and draws the visjs network.


        function draw() {
                nodes = new vis.DataSet([]);
                edges = new vis.DataSet([]);

                var container = document.getElementById('network');

                var data = {
                        nodes: nodes,
                        edges: edges
                };

                var options = {
			interaction:{
				hover:true,
				hoverConnectedEdges:true,
				},
                        "edges":{
                                "font":{face:'arial'},
                                "width": 7,
                                "length": 20,
				"color":{
					color:'#C13619',
					highlight:'#0C4C8C',
					hover:'#0C4C8C'}
                                },
                        "nodes": {
                                "font":{face:'arial'},
                                "borderWidth": 10,
                                "color": {
                                        border: '#C13619',
                                        highlight:'#0C4C8C',
					hover:'#0C4C8C'}
                        	},
                        "physics": {
                                "forceAtlas2Based": {
                                        "centralGravity": 0.008,
                                        "springConstant": 0.04,
                                        "damping": 0.8
                                },
                                "solver": "forceAtlas2Based",
				"maxVelocity": 10,
    				"minVelocity": 1,
    				"timestep": 0.4,
                        }
                };

                network = new vis.Network(container, data, options);
                network.fit();

                network.on("click", function (params) {
                        if(params.nodes[0]!=null){
                                getRelated(params.nodes[0]);
                        }});

                network.on("doubleClick", function (params) {
                        if(params.nodes[0]!=null){
                                var uri = String(params.nodes[0])
                                window.open(String(params.nodes[0]).replace("http://dbpedia.org/resource/", "https://en.wikipedia.org/wiki/"));
                        }});

        }

        function start() {
                let names_box = $('#names_box');
                names.forEach(name => {
                        names_box.append($('<option>').attr('value', name));
                });
        }
        
	function instruction() {
		setTimeout(function(){document.getElementById('statement').innerHTML = instructionText}, 1000);
	};
     </script>
</head>

<body onload="start(); init('Elizabeth II');">
        <div id="topFrame">
        <input list="names_box"; onchange="init(value)"; value="Elizabeth II"; onclick="value=''"/>
        <datalist id="names_box"></datalist>
        <div align="center"; id="statement"></div>
        </div>
        <div id="network"></div>
        
        </select>
        <div  align="center"; id="statement2">Dataset by DBpedia. Graph visualisation by <a href="http://visjs.org">vis.js</a>. <a href="http://epistemik.co">Epistemik</a> 2020. </div>
</body>
</html>
